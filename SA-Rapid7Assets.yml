name: SA-Rapid7Assets
short_name: rapid7
author: ZachTheSplunker
email: zach@zachthesplunker.com
version: 1.0.2
description: >-
  This supporting add-on allows asset 
  information pulled from Rapid7 to be used with 
  Splunk Enterprise Security's Asset Database.
default_index: rapid7
asset_retention: -30d
search: >-
  `sa_rapid7_index` sourcetype="rapid7:insightvm:asset"
  | dedup id
  | eventstats p95(risk_score) as upper_risk
  | eval
    category=mvjoin(mvsort(mvappend(
    "gen: sa-rapid7assets",
    "exploits: ".exploits,
    "policies_assessed: ".assessed_for_policies,
    "vuln_assessed: ".assessed_for_vulnerabilities,
    "vuln_critical: ".critical_vulnerabilities,
    "last_scan: ".strftime(strptime(last_scan_end,"%FT%T.%3N%Z"), "%x %T %Z"),
    "splunk_last_updated: ".strftime(now(), "%x %T %Z"),
    "vuln_moderate: ".moderate_vulnerabilities,
    "os_arch: ".os_architecture,
    "os_description: ".os_description,
    "os_family: ".os_family,
    "os_name: ".os_name,
    "os_system_name: ".os_system_name,
    "os_type: ".os_type,
    "os_vendor: ".os_vendor,
    "os_version: ".os_version,
    "risk_score: ".risk_score,
    "vuln_severe: ".severe_vulnerabilities,
    "tags: ".mvjoin(mvzip('tags{}.type', 'tags{}.name', ": "), ", "),
    "id: ".id,
    "type: ".type,
    "vuln_total: ".total_vulnerabilities
    )), "|"),
    nt_host=mvindex(split(host_name, "."),0),
    dns='host_name',
    priority=case(exploits>=1, "critical", match(category, "(?i)server"), "high", critical_vulnerabilities>=1, "high", risk_score>=upper_risk, "high", moderate_vulnerabilities>=1, "medium", true(), "low"),
    _key='id',
    _last_seen=now()
  | table _key,_last_seen,ip,mac,nt_host,dns,priority,bunit,category
  | outputlookup key_field=_key sa_rapid7_assets
  | stats count
asset_fields:
  - bunit
  - category
  - city
  - country
  - dns
  - ip
  - is_expected
  - lat
  - long
  - mac
  - nt_host
  - priority
dependencies:
  - name: TA-rapid7-insightvm
    version: ">=1.3.2"
    