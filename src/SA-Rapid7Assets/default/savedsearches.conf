# DO NOT EDIT THIS FILE!
# Please make all changes to files in ../local.
# To make changes, copy the section/stanza you want to change from ./default
# into ../local and edit there.

[Rapid7 Assets - Lookup Gen]
disabled = false
cron_schedule = 39 * * * *
description = populates kvstore lookup: sa_rapid7_assets
dispatch.earliest_time = -61m@m
dispatch.latest_time = -1m@m
enableSched = 1
schedule_window = auto
search = `sa_rapid7_index` sourcetype="rapid7:insightvm:asset"\
| dedup id\
| eventstats p95(risk_score) as upper_risk\
| eval\
    category=mvjoin(mvsort(mvappend(\
    "gen: sa-rapid7assets",\
    "exploits: ".exploits,\
    "policies_assessed: ".assessed_for_policies,\
    "vuln_assessed: ".assessed_for_vulnerabilities,\
    "vuln_critical: ".critical_vulnerabilities,\
    "last_scan: ".strftime(strptime(last_scan_end,"%FT%T.%3N%Z"), "%x %T %Z"),\
    "splunk_last_updated: ".strftime(now(), "%x %T %Z"),\
    "vuln_moderate: ".moderate_vulnerabilities,\
    "os_arch: ".os_architecture,\
    "os_description: ".os_description,\
    "os_family: ".os_family,\
    "os_name: ".os_name,\
    "os_system_name: ".os_system_name,\
    "os_type: ".os_type,\
    "os_vendor: ".os_vendor,\
    "os_version: ".os_version,\
    "risk_score: ".risk_score,\
    "vuln_severe: ".severe_vulnerabilities,\
    "tags: ".mvjoin(mvzip('tags{}.type', 'tags{}.name', ": "), ", "),\
    "id: ".id,\
    "type: ".type,\
    "vuln_total: ".total_vulnerabilities\
    )), "|"),\
    nt_host=mvindex(split(host_name, "."),0),\
    dns='host_name',\
    priority=case(exploits>=1, "critical", match(category, "(?i)server"), "high", critical_vulnerabilities>=1, "high", risk_score>=upper_risk, "high", moderate_vulnerabilities>=1, "medium", true(), "low"),\
    _key='id',\
    _last_seen=now()\
| table _key,_last_seen,ip,mac,nt_host,dns,priority,bunit,category\
| outputlookup key_field=_key sa_rapid7_assets\
| stats count

[Rapid7 Assets - Lookup Cleanup]
disabled = false
cron_schedule = 3 3 * * *
description = removes old entries from kvstore lookup: sa_rapid7_assets
dispatch.earliest_time = -1s
dispatch.latest_time = now
enableSched = 1
schedule_window = auto
search = | inputlookup sa_rapid7_assets \
| where _last_seen>relative_time(now(), `sa_rapid7_retention`) \
| outputlookup sa_rapid7_assets \
| stats count
